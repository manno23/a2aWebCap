# Connection Layer Visualization

This document visualizes the socket connections, RPC layer, and message flow in the A2A WebCap implementation.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          A2A WebCap Architecture                            │
└─────────────────────────────────────────────────────────────────────────────┘

CLIENT SIDE                                          SERVER SIDE
┌────────────────────────┐                          ┌────────────────────────┐
│   Application Layer    │                          │   Application Layer    │
│  ┌──────────────────┐  │                          │  ┌──────────────────┐  │
│  │   A2AClient      │  │                          │  │   A2AService     │  │
│  │   - sendMessage()│  │                          │  │   extends        │  │
│  │   - getTask()    │  │                          │  │   RpcTarget      │  │
│  │   - listTasks()  │  │                          │  └──────────────────┘  │
│  └──────────────────┘  │                          │  ┌──────────────────┐  │
│          ↕             │                          │  │  StreamingTask   │  │
│  ┌──────────────────┐  │                          │  │   extends        │  │
│  │   RPC Stub Layer │  │                          │  │   RpcTarget      │  │
│  │  - Request/Reply │  │                          │  └──────────────────┘  │
│  │  - Promise-based │  │                          │          ↕             │
│  │  - Timeout mgmt  │  │                          │  ┌──────────────────┐  │
│  └──────────────────┘  │                          │  │  RPC Handler     │  │
│          ↕             │                          │  │  - Method invoke │  │
│  ┌──────────────────┐  │                          │  │  - Serialization │  │
│  │  JSON Encoding   │  │                          │  └──────────────────┘  │
│  └──────────────────┘  │                          │          ↕             │
└────────────────────────┘                          └────────────────────────┘
          ↕                                                    ↕
┌────────────────────────┐                          ┌────────────────────────┐
│   Transport Layer      │                          │   Transport Layer      │
│  ┌──────────────────┐  │                          │  ┌──────────────────┐  │
│  │   WebSocket      │  │◄────────────────────────►│  │   WebSocket      │  │
│  │   ws://...       │  │   Bidirectional Stream   │  │   Server         │  │
│  └──────────────────┘  │                          │  └──────────────────┘  │
└────────────────────────┘                          └────────────────────────┘
          ↕                                                    ↕
┌────────────────────────┐                          ┌────────────────────────┐
│   Network Layer        │                          │   Network Layer        │
│  TCP Socket Connection │◄────────────────────────►│  TCP Socket Listener   │
│  Port: 8080           │                          │  Bind: 0.0.0.0:8080    │
└────────────────────────┘                          └────────────────────────┘
```

## Detailed Layer Breakdown

### Layer 1: TCP Socket Layer

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ TCP SOCKET LAYER                                                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Client Socket                                    Server Socket              │
│  ┌────────────────┐                              ┌────────────────┐         │
│  │ File Desc: 3   │─────── SYN ─────────────────►│ Listen: 8080   │         │
│  │ State: CLOSED  │                              │ State: LISTEN  │         │
│  └────────────────┘                              └────────────────┘         │
│         │                                                 │                  │
│         │◄──────── SYN-ACK ────────────────────────────────┘                 │
│         │                                                                    │
│  ┌────────────────┐                              ┌────────────────┐         │
│  │ State: SYN_SENT│─────── ACK ─────────────────►│ State: ESTAB   │         │
│  └────────────────┘                              └────────────────┘         │
│         │                                                 │                  │
│  ┌────────────────┐                              ┌────────────────┐         │
│  │ State: ESTAB   │◄──────────────────────────────│ Accept conn    │         │
│  │ Local:  :52341 │                              │ Remote: :52341 │         │
│  │ Remote: :8080  │                              │ Local:  :8080  │         │
│  └────────────────┘                              └────────────────┘         │
│                                                                              │
│  Properties:                                                                 │
│  • Protocol: TCP                                                             │
│  • Keep-Alive: Enabled                                                       │
│  • Nagle: Disabled (for low latency)                                        │
│  • Buffer Size: 64KB send/recv                                              │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Layer 2: WebSocket Upgrade & Framing

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ WEBSOCKET LAYER                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Client                                           Server                     │
│  ┌────────────────┐                              ┌────────────────┐         │
│  │ HTTP Upgrade   │                              │ HTTP Handler   │         │
│  └────────────────┘                              └────────────────┘         │
│         │                                                 │                  │
│         │──── GET / HTTP/1.1 ─────────────────────────────►                 │
│         │     Upgrade: websocket                          │                  │
│         │     Connection: Upgrade                         │                  │
│         │     Sec-WebSocket-Key: dGhlIHNhbXBsZQ==         │                  │
│         │     Sec-WebSocket-Version: 13                   │                  │
│         │                                                 │                  │
│         │◄──── HTTP/1.1 101 Switching Protocols ──────────┘                 │
│         │      Upgrade: websocket                                           │
│         │      Connection: Upgrade                                          │
│         │      Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYG...                     │
│         │                                                                    │
│  ┌────────────────┐                              ┌────────────────┐         │
│  │ WS Connected   │◄────────────────────────────►│ WS Connected   │         │
│  │ State: OPEN    │                              │ State: OPEN    │         │
│  └────────────────┘                              └────────────────┘         │
│                                                                              │
│  Frame Format:                                                               │
│  ┌─────┬──────┬─────────┬──────────┬──────────────────────────────┐        │
│  │ FIN │ RSV  │ OPCODE  │ MASK|LEN │ PAYLOAD                      │        │
│  ├─────┼──────┼─────────┼──────────┼──────────────────────────────┤        │
│  │ 1   │ 000  │ 0x1     │ 1 + len  │ JSON-RPC message            │        │
│  │     │      │ (text)  │          │                              │        │
│  └─────┴──────┴─────────┴──────────┴──────────────────────────────┘        │
│                                                                              │
│  Message Types:                                                              │
│  • 0x1: Text Frame (JSON-RPC messages)                                      │
│  • 0x2: Binary Frame (CapnProto - future)                                   │
│  • 0x8: Close Frame                                                         │
│  • 0x9: Ping Frame                                                          │
│  • 0xA: Pong Frame                                                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Layer 3: RPC Protocol Layer (CapnWeb over JSON-RPC)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ RPC LAYER                                                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Client Stub                                      Server Stub                │
│  ┌────────────────────────────────────────┐      ┌──────────────────────┐   │
│  │ Method: sendMessage()                  │      │ RpcTarget            │   │
│  │ ┌────────────────────────────────────┐ │      │ ┌──────────────────┐ │   │
│  │ │ 1. Generate request ID             │ │      │ │ Method Registry  │ │   │
│  │ │    id = randomUUID()               │ │      │ │ ┌──────────────┐ │ │   │
│  │ │    "550e8400-e29b-41d4-a716-..."   │ │      │ │ │ sendMessage  │ │ │   │
│  │ └────────────────────────────────────┘ │      │ │ │ getTask      │ │ │   │
│  │ ┌────────────────────────────────────┐ │      │ │ │ listTasks    │ │ │   │
│  │ │ 2. Serialize parameters            │ │      │ │ │ cancelTask   │ │ │   │
│  │ │    params = {                      │ │      │ │ │ ...          │ │ │   │
│  │ │      message: Message,             │ │      │ │ └──────────────┘ │ │   │
│  │ │      config: {...}                 │ │      │ └──────────────────┘ │   │
│  │ │    }                               │ │      └──────────────────────┘   │
│  │ └────────────────────────────────────┘ │                │                │
│  │ ┌────────────────────────────────────┐ │                │                │
│  │ │ 3. Create JSON-RPC request         │ │                │                │
│  │ │    {                               │ │                │                │
│  │ │      "id": "550e8400...",          │ │                │                │
│  │ │      "method": "sendMessage",      │ │                │                │
│  │ │      "params": {...}               │ │                │                │
│  │ │    }                               │ │                │                │
│  │ └────────────────────────────────────┘ │                │                │
│  │ ┌────────────────────────────────────┐ │                │                │
│  │ │ 4. Register pending promise        │ │                │                │
│  │ │    pendingRequests.set(id, {       │ │                │                │
│  │ │      resolve, reject, timer        │ │                │                │
│  │ │    })                              │ │                │                │
│  │ └────────────────────────────────────┘ │                │                │
│  │ ┌────────────────────────────────────┐ │                │                │
│  │ │ 5. Send via WebSocket              │ │                │                │
│  │ │    ws.send(JSON.stringify(req))    │─────────────────►│                │
│  │ └────────────────────────────────────┘ │      ┌──────────▼────────────┐ │
│  │                                        │      │ Parse JSON           │ │
│  │                                        │      │ Extract: id, method  │ │
│  │                                        │      │ Deserialize params   │ │
│  │                                        │      └──────────┬────────────┘ │
│  │                                        │      ┌──────────▼────────────┐ │
│  │                                        │      │ Lookup method        │ │
│  │                                        │      │ Invoke handler       │ │
│  │                                        │      │ await sendMessage()  │ │
│  │                                        │      └──────────┬────────────┘ │
│  │                                        │      ┌──────────▼────────────┐ │
│  │                                        │      │ Serialize result     │ │
│  │                                        │      │ Create response      │ │
│  │ ┌────────────────────────────────────┐ │      │ {                    │ │
│  │ │ 6. Receive response                │◄─────────│   "id": "550...",   │ │
│  │ │    {                               │ │      │   "result": {...}  │ │
│  │ │      "id": "550e8400...",          │ │      │ }                    │ │
│  │ │      "result": Task                │ │      └──────────────────────┘ │
│  │ │    }                               │ │                                │
│  │ └────────────────────────────────────┘ │                                │
│  │ ┌────────────────────────────────────┐ │                                │
│  │ │ 7. Resolve promise                 │ │                                │
│  │ │    const req = pendingRequests     │ │                                │
│  │ │                .get(response.id)   │ │                                │
│  │ │    req.resolve(response.result)    │ │                                │
│  │ │    pendingRequests.delete(id)      │ │                                │
│  │ └────────────────────────────────────┘ │                                │
│  └────────────────────────────────────────┘                                │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Layer 4: Application Layer (A2A Protocol)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ APPLICATION LAYER                                                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  A2AClient                                        A2AService                 │
│  ┌──────────────────────┐                        ┌──────────────────────┐   │
│  │ sendMessage()        │───────────────────────►│ sendMessage()        │   │
│  │  - Validate message  │                        │  - Create task       │   │
│  │  - Call RPC stub     │                        │  - Process msg       │   │
│  │  - Return promise    │                        │  - Update state      │   │
│  └──────────────────────┘                        └──────────────────────┘   │
│  ┌──────────────────────┐                        ┌──────────────────────┐   │
│  │ getTask()            │───────────────────────►│ getTask()            │   │
│  │  - Query by taskId   │                        │  - Lookup task       │   │
│  │  - History limit     │                        │  - Return task obj   │   │
│  └──────────────────────┘                        └──────────────────────┘   │
│  ┌──────────────────────┐                        ┌──────────────────────┐   │
│  │ listTasks()          │───────────────────────►│ listTasks()          │   │
│  │  - Query params      │                        │  - Filter tasks      │   │
│  │  - Pagination        │                        │  - Paginate results  │   │
│  └──────────────────────┘                        └──────────────────────┘   │
│                                                                              │
│  State Management:                               ┌──────────────────────┐   │
│  ┌──────────────────────┐                        │ TaskManager          │   │
│  │ pendingRequests      │                        │ ┌──────────────────┐ │   │
│  │ ┌──────────────────┐ │                        │ │ tasks: Map<>     │ │   │
│  │ │ req-001 → {...}  │ │                        │ │ ┌──────────────┐ │ │   │
│  │ │ req-002 → {...}  │ │                        │ │ │ task-abc-123 │ │ │   │
│  │ │ req-003 → {...}  │ │                        │ │ │ task-def-456 │ │ │   │
│  │ └──────────────────┘ │                        │ │ │ task-ghi-789 │ │ │   │
│  └──────────────────────┘                        │ │ └──────────────┘ │ │   │
│                                                   │ └──────────────────┘ │   │
│                                                   └──────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

## Connection Lifecycle

```
CLIENT                                                          SERVER
  │                                                               │
  │ ┌─────────────────────────────────────────────────────────┐  │
  │ │ Phase 1: TCP Connection Establishment                   │  │
  │ └─────────────────────────────────────────────────────────┘  │
  │                                                               │
  │──────────────── TCP SYN ───────────────────────────────────►│
  │                                                               │
  │◄─────────────── TCP SYN-ACK ────────────────────────────────│
  │                                                               │
  │──────────────── TCP ACK ───────────────────────────────────►│
  │                                                               │
  │ ┌─────────────────────────────────────────────────────────┐  │
  │ │ Phase 2: WebSocket Upgrade                              │  │
  │ └─────────────────────────────────────────────────────────┘  │
  │                                                               │
  │──────────────── HTTP Upgrade Request ──────────────────────►│
  │ GET / HTTP/1.1                                                │
  │ Upgrade: websocket                                            │
  │ Sec-WebSocket-Key: ...                                        │
  │                                                               │
  │◄─────────────── HTTP 101 Switching Protocols ───────────────│
  │ Upgrade: websocket                                            │
  │ Sec-WebSocket-Accept: ...                                     │
  │                                                               │
  │ ┌─────────────────────────────────────────────────────────┐  │
  │ │ Phase 3: Welcome & Capability Exchange                  │  │
  │ └─────────────────────────────────────────────────────────┘  │
  │                                                               │
  │◄─────────────── Welcome Message ────────────────────────────│
  │ {                                                             │
  │   "type": "welcome",                                          │
  │   "server": "A2A CapnWeb Server",                            │
  │   "protocolVersion": "0.4.0"                                 │
  │ }                                                             │
  │                                                               │
  │──────────────── getAgentCard() RPC ────────────────────────►│
  │                                                               │
  │◄─────────────── AgentCard Response ─────────────────────────│
  │ {                                                             │
  │   "protocolVersion": "0.4.0",                                │
  │   "capabilities": {streaming: true, ...}                     │
  │ }                                                             │
  │                                                               │
  │ ┌─────────────────────────────────────────────────────────┐  │
  │ │ Phase 4: Active Communication                            │  │
  │ └─────────────────────────────────────────────────────────┘  │
  │                                                               │
  │──────────────── sendMessage() RPC ─────────────────────────►│
  │                                                               │
  │◄─────────────── Task Created Response ──────────────────────│
  │                                                               │
  │──────────────── getTask() RPC ─────────────────────────────►│
  │                                                               │
  │◄─────────────── Task Status Response ───────────────────────│
  │                                                               │
  │ ┌─────────────────────────────────────────────────────────┐  │
  │ │ Phase 5: Streaming Updates (Optional)                   │  │
  │ └─────────────────────────────────────────────────────────┘  │
  │                                                               │
  │──────────────── sendMessageStreaming() RPC ────────────────►│
  │                                                               │
  │◄─────────────── StreamingTask Stub ─────────────────────────│
  │                                                               │
  │──────────────── subscribe(callback) ───────────────────────►│
  │                                                               │
  │◄─────────────── onStatusUpdate() ───────────────────────────│
  │                 (server → client push)                        │
  │                                                               │
  │◄─────────────── onStatusUpdate() ───────────────────────────│
  │                 (server → client push)                        │
  │                                                               │
  │◄─────────────── onArtifactUpdate() ─────────────────────────│
  │                 (server → client push)                        │
  │                                                               │
  │◄─────────────── onStatusUpdate(final=true) ─────────────────│
  │                 (server → client push)                        │
  │                                                               │
  │ ┌─────────────────────────────────────────────────────────┐  │
  │ │ Phase 6: Connection Teardown                            │  │
  │ └─────────────────────────────────────────────────────────┘  │
  │                                                               │
  │──────────────── WebSocket Close Frame ─────────────────────►│
  │                                                               │
  │◄─────────────── Close Acknowledgment ───────────────────────│
  │                                                               │
  │──────────────── TCP FIN ───────────────────────────────────►│
  │                                                               │
  │◄─────────────── TCP FIN-ACK ────────────────────────────────│
  │                                                               │
  │──────────────── TCP ACK ───────────────────────────────────►│
  │                                                               │
  ▼                                                               ▼
CLOSED                                                         CLOSED
```

## Concurrent Connections View

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Server Connection Pool                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ WebSocket Server (Port 8080)                                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                    │          │          │          │                        │
│         ┌──────────┴──────┐   │          │          │                        │
│         │                 │   │          │          │                        │
│    ┌────▼─────┐     ┌────▼─────┐  ┌────▼─────┐  ┌──▼───────┐              │
│    │ WS Conn  │     │ WS Conn  │  │ WS Conn  │  │ WS Conn  │              │
│    │ #1       │     │ #2       │  │ #3       │  │ #4       │              │
│    ├──────────┤     ├──────────┤  ├──────────┤  ├──────────┤              │
│    │ Client:  │     │ Client:  │  │ Client:  │  │ Client:  │              │
│    │ :52341   │     │ :52342   │  │ :52343   │  │ :52344   │              │
│    ├──────────┤     ├──────────┤  ├──────────┤  ├──────────┤              │
│    │ A2A Svc  │     │ A2A Svc  │  │ A2A Svc  │  │ A2A Svc  │              │
│    │ Instance │     │ Instance │  │ Instance │  │ Instance │              │
│    ├──────────┤     ├──────────┤  ├──────────┤  ├──────────┤              │
│    │ User:    │     │ User:    │  │ User:    │  │ User:    │              │
│    │ alice    │     │ bob      │  │ charlie  │  │ alice    │              │
│    ├──────────┤     ├──────────┤  ├──────────┤  ├──────────┤              │
│    │ Active   │     │ Active   │  │ Active   │  │ Active   │              │
│    │ Tasks: 2 │     │ Tasks: 1 │  │ Tasks: 5 │  │ Tasks: 0 │              │
│    └──────────┘     └──────────┘  └──────────┘  └──────────┘              │
│         │                │             │             │                       │
│         └────────────────┴─────────────┴─────────────┘                       │
│                          │                                                   │
│                  ┌───────▼────────┐                                          │
│                  │  Task Manager  │                                          │
│                  │  (Shared State)│                                          │
│                  └────────────────┘                                          │
│                          │                                                   │
│                  ┌───────▼────────┐                                          │
│                  │  Task Storage  │                                          │
│                  │  ┌──────────┐  │                                          │
│                  │  │ task-001 │  │                                          │
│                  │  │ task-002 │  │                                          │
│                  │  │ task-003 │  │                                          │
│                  │  │ task-004 │  │                                          │
│                  │  │ ...      │  │                                          │
│                  │  └──────────┘  │                                          │
│                  └────────────────┘                                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

Next: See `message-flow-visualization.md` for detailed request/response flows with color-coded message tracking.
